{% import "macros/html.html" as macros %}
{% extends "vfinance_base_internal.html" %}

{% block content %}

<div>
    {{transaction.transaction_type|replace('_', ' ')|translate}} |
    Contract: {{transaction.get_financial_accounts()|join(', ', attribute='id')}} |
    {{transaction.agreement_code}} |
    TransactieID: {{transaction.id}} |
    Ingegeven door: ________________
</div>
<hr>

{% set items_collection = [('Afkoopformulier', ''),
                           ('Datum ondertekening', transaction.agreement_date|date),
                           ('Ontvangstdatum', transaction.from_date|date),
                           ('Rekeningnummer(s)', 'Aantal %s'|format(transaction.distributed_via|length))] %}
{{ macros.checklist(items_collection, title='Transactiedocument en Identificatie', date=false) }}

{% set items_collection = [] %}
{% for role in insured_parties %}
  {% do items_collection.append(('VN %s'|format(loop.index), 
                                [('Handtek.', ''),
                                 ('ID-kaart', ''),
                                 ('Identificatie', '%s (RRnr: %s)'|format(role.name, role.registration_number)),])) %}
{% endfor %}
{{ macros.checklists(items_collection, date=false) }}

{% set attorney_clauses = [] %}
{% set conventional_return_clauses = [] %}
{% set beneficiary_clauses = [] %}
{% for desc, clause in account_items %}
    {% if desc == 'attorney' %}
        {% do attorney_clauses.append((desc, clause|safe)) %}
    {% elif desc == 'conventional return' %}
        {% do conventional_return_clauses.append((desc, clause|safe)) %}
    {% elif desc == 'beneficiary' %}
        {% do beneficiary_clauses.append((desc, clause|safe)) %}
    {% endif %}
{% endfor %}

{% set items_collection = attorney_clauses + conventional_return_clauses %}

{% if items_collection %}
  {{ macros.checklist(items_collection, title='Rechten', date=false) }}
{% endif %}

{% set items_collection = beneficiary_clauses %}

{% if items_collection %}
  {{ macros.checklist(items_collection, title='Begunstiging', date=false) }}
{% endif %}

{% set items_collection = [] %}
{% for tps in transaction.consisting_of %}
  {% for role in tps.premium_schedule.financial_account.get_roles_at(transaction.agreement_date, described_by='insured_party') if role.datum_overlijden %}
    {% do items_collection.append('Overlijden %s: %s'|format(role.name, role.datum_overlijden)) %}
  {% endfor %}
{% endfor %}
{% for tps in transaction.consisting_of %}
  {% for applied_coverage in tps.premium_schedule.applied_coverages %}
    {% do items_collection.append('%s - %s: %s - limit: %s'|format(applied_coverage.from_date|date,
                                                                   applied_coverage.thru_date|date,
                                                                   applied_coverage.coverage_for,
                                                                   applied_coverage.coverage_limit)) %}
  {% endfor %}
{% endfor %}
{% if items_collection %}
  {{ macros.checklist_no_values(items_collection, title='Aanvullende waarborg', date=false) }}
{% endif %}


{% set account_state_rows = [] %}
{% set funds_collection = [] %}
{% for account_state in account_states %}
    {% do account_state_rows.append(['Schedule',
                                     'Capital',
                                     'Interest',
                                     'Additional interest',
                                     'Profit sharing',
                                     'Value']) %}
    {% for premium_schedule_state in account_state.premium_schedule_states %}
        {% do account_state_rows.append(['%s - ref : %s / %s'|format(premium_schedule_state.premium_data.product_name,
                                                                     premium_schedule_state.premium_data.premium_schedule.account_suffix,
                                                                     premium_schedule_state.premium_data.premium_schedule.rank),
                                         premium_schedule_state.capital|currency,
                                         premium_schedule_state.interest|currency,
                                         premium_schedule_state.additional_interest|currency,
                                         premium_schedule_state.profit_sharing|currency,
                                         premium_schedule_state.value|currency]) %}
    {% endfor %}
    {% for security_data in account_state.securities %}
        {% do funds_collection.append((security_data.name, 
                                       'Units: %s Quotation: %s Value: %s'|format(security_data.thru_quantity|currency,
                                                                                  security_data.security_quotation|currency, 
                                                                                  security_data.thru_value|currency))) %}
    {% endfor %}
{% endfor %}

{% if account_state_rows %}
  {{ macros.table(account_state_rows, title='Account state', first_row_header=true, checkbox=true) }}
{% endif %}
{% if funds_collection %}
  {{ macros.checklist(funds_collection, title='Funds', date=false) }}
{% endif %}

{% set transaction_funds_out_rows = [['Product', 'Quantity', 'Fund', 'Distribution', 'Quotation']] %}
{% set transaction_funds_in_rows = [['Product', 'Quantity', 'Fund', 'Distribution', 'Quotation']] %}
{% for ftps in transaction.consisting_of %}
  {% set ftps_type = '' %}
  {% if ftps.described_by == 'percentage' %}{% set ftps_type = '%' %}{% endif %}
  {% if ftps.described_by == 'amount' %}{% set ftps_type = 'EUR' %}{% endif %}

  {% if ftps.quantity < 0 %}
    {% do transaction_funds_out_rows.append([ftps.premium_schedule.product,
                                             '%s %s'|format(ftps.quantity|currency, ftps_type), 
                                             '',
                                             '',
                                             '']) %}
    {% for fund_distribution in ftps.get_fund_distribution() %}
      {% do transaction_funds_out_rows.append(['',
                                               '',
                                               fund_distribution.fund,
                                               fund_distribution.target_percentage|currency,
                                               '_________________']) %}
    {% endfor %}
  {% else %}
    {% do transaction_funds_in_rows.append([ftps.premium_schedule.product,
                                            '%s %s'|format(ftps.quantity|currency, ftps_type), 
                                            '',
                                            '',
                                            '']) %}
    {% for fund_distribution in ftps.get_fund_distribution() %}
      {% do transaction_funds_in_rows.append(['',
                                              '',
                                              fund_distribution.fund,
                                              fund_distribution.target_percentage|currency,
                                              '_________________']) %}
    {% endfor %}
  {% endif %}
  
{% endfor %}
{% if transaction_funds_out_rows|length > 1 %}
  {{ macros.table(transaction_funds_out_rows, title='Afkoop/switch-out', first_row_header=true, checkbox=true, color_cycle=false) }}
{% endif %}
{% if transaction_funds_in_rows|length > 1 %}
  {{ macros.table(transaction_funds_in_rows, title='Switch-in', first_row_header=true, checkbox=true, color_cycle=false) }}
{% endif %}



{% set items_collection = [] %}
{% for tps in transaction.consisting_of %}
    {% for feature in tps.premium_schedule.applied_features%}
        {% do items_collection.append(('%s (%s)'|format(feature.described_by|replace('_', ' ')|capitalize,
                                                        tps),
                                       '%s %s'|format(feature.value|currency, feature.suffix))) %}
    {% endfor %}
{% endfor %}
{% if items_collection %}
  {{ macros.checklist(items_collection, title='Overzicht features', date=false) }}
{% endif %}
<br>
<br>
<br>
<h3>Opmerkingen</h3>
<br>
<div>{{transaction_text}}</div>
<br>
<hr>
<table width="100%">
    <tr>
        <td>&#x25fb; ____________________________</td>
        <td>Controle door: ________________</td>
    </tr>
    <tr>
        <td>&#x25fb; ____________________________</td>
        <td>Controle op: __________________</td>
    </tr>
</table>
<br>
<table width="100%" border="1"><tr><td><br><br><br><br><br><br></td></tr></table>


<h2>BOEKHOUDING</h2>
<h3>Uitbetaling begunstigde:</h3>
{% for credit_account in transaction.distributed_via %}
    <div>Naam: ____________________________</div>
    <div>Rekening  {{credit_account.iban}} referentie: ____________________________</div>
    <br>
{% endfor %}

<h3>Herinvestering contract Patronale Life:</h3>
<div>Voorstelnummer: ____________________________</div>

<h3>Transfer andere verzekeringsmaatschappij:</h3>
<div>Referentie: ____________________________</div>
<div>Rekeningnummer: ____________________________</div>
<hr>
<table width="100%">
    <tr>
        <td>&#x25fb; ____________________________</td>
        <td>Controle door: ________________</td>
    </tr>
    <tr>
        <td>&#x25fb; ____________________________</td>
        <td>Controle op: __________________</td>
    </tr>
</table>
<br>
<table width="100%" border="1"><tr><td><br><br><br><br><br><br></td></tr></table>


{% endblock %}
